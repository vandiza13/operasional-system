// prisma/schema.prisma

generator client {
  provider        = "prisma-client-js"
  binaryTargets   = ["native", "rhel-openssl-3.0.x"]
  previewFeatures = ["driverAdapters"] // WAJIB DI PRISMA 5 JIKA PAKAI TiDB ADAPTER
}

datasource db {
  provider = "mysql" // TiDB compatible
  url      = env("DATABASE_URL") // KEMBALI DILETAKKAN DI SINI UNTUK PRISMA 5
}

enum Role {
  ADMIN
  TECHNICIAN
  SUPER_ADMIN
}

enum ExpenseStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}

enum AttachmentType {
  RECEIPT
  EVIDENCE_1
  EVIDENCE_2
  EVIDENCE_3
}

model User {
  id               String            @id @default(cuid())
  nik              String?           @unique // NIK Karyawan
  name             String            // Nama Lengkap
  email            String            @unique
  phone            String?           // Nomor Telepon
  position         String?           // Jabatan / Position Name
  password         String
  role             Role              @default(TECHNICIAN)
  
  expenses         Expense[]         @relation("UserExpenses")
  approvedExpenses Expense[]         @relation("AdminApprover")
  
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@index([role])
}

model ExpenseCategory {
  id        String    @id @default(cuid())
  name      String
  isActive  Boolean   @default(true)
  expenses  Expense[]
  createdAt DateTime  @default(now())
}

model Expense {
  id               String              @id @default(cuid())
  userId           String
  user             User                @relation("UserExpenses", fields: [userId], references: [id])
  
  categoryId       String
  category         ExpenseCategory     @relation(fields: [categoryId], references: [id])
  
  expenseDate      DateTime
  amount           Decimal             @db.Decimal(12, 2)
  description      String?             @db.Text

  status           ExpenseStatus       @default(PENDING)

  approvedById     String?
  approver         User?               @relation("AdminApprover", fields: [approvedById], references: [id])
  approvedAt       DateTime?

  paidAt           DateTime?
  paymentReference String?

  attachments      ExpenseAttachment[]

  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  @@index([status, approvedAt])
  @@index([userId])
  @@index([createdAt])
  @@index([expenseDate])
}

model ExpenseAttachment {
  id        String         @id @default(cuid())
  expenseId String
  expense   Expense        @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  
  type      AttachmentType
  fileUrl   String         @db.Text
  createdAt DateTime       @default(now())

  @@index([expenseId])
  @@index([type])
}