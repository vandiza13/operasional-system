// prisma/schema.prisma

generator client {
  provider        = "prisma-client-js"
  binaryTargets   = ["native", "rhel-openssl-3.0.x"]
  previewFeatures = ["driverAdapters"] // WAJIB DI PRISMA 5 JIKA PAKAI TiDB ADAPTER
}

datasource db {
  provider = "mysql" // TiDB compatible
  url      = env("DATABASE_URL") // KEMBALI DILETAKKAN DI SINI UNTUK PRISMA 5
}

enum Role {
  ADMIN
  TECHNICIAN
  SUPER_ADMIN
}

enum ExpenseStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}

enum AttachmentType {
  RECEIPT
  EVIDENCE_1
  EVIDENCE_2
  EVIDENCE_3
}

// [BARU] Tipe transaksi untuk Buku Kas
enum TransactionType {
  TOP_UP       // Dana Masuk dari Pusat
  DISBURSEMENT // Dana Keluar untuk Pencairan Bon
}

model User {
  id               String              @id @default(cuid())
  nik              String?             @unique // NIK Karyawan
  name             String              // Nama Lengkap
  email            String              @unique
  phone            String?             // Nomor Telepon
  position         String?             // Jabatan / Position Name
  password         String
  role             Role                @default(TECHNICIAN)
  
  // Relasi Lama
  expenses         Expense[]           @relation("UserExpenses")
  approvedExpenses Expense[]           @relation("AdminApprover")

  // [BARU] Relasi untuk fitur Saldo & Pencairan
  ledgersCreated   OperationalLedger[] @relation("AdminLedger")
  payoutsReceived  PayoutBatch[]       @relation("TechnicianPayouts")
  payoutsProcessed PayoutBatch[]       @relation("AdminPayoutBatch")
  
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  @@index([role])
}

model ExpenseCategory {
  id        String    @id @default(cuid())
  name      String
  isActive  Boolean   @default(true)
  expenses  Expense[]
  createdAt DateTime  @default(now())
}

model Expense {
  id               String              @id @default(cuid())
  userId           String
  user             User                @relation("UserExpenses", fields: [userId], references: [id])
  
  categoryId       String
  category         ExpenseCategory     @relation(fields: [categoryId], references: [id])
  
  expenseDate      DateTime
  amount           Decimal             @db.Decimal(12, 2)
  description      String?             @db.Text

  status           ExpenseStatus       @default(PENDING)

  approvedById     String?
  approver         User?               @relation("AdminApprover", fields: [approvedById], references: [id])
  approvedAt       DateTime?

  paidAt           DateTime?
  paymentReference String?

  attachments      ExpenseAttachment[]

  // [BARU] Relasi ke Batch Pencairan
  payoutBatchId    String?
  payoutBatch      PayoutBatch?        @relation(fields: [payoutBatchId], references: [id])

  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  @@index([status, approvedAt])
  @@index([userId])
  @@index([createdAt])
  @@index([expenseDate])
  @@index([payoutBatchId]) // [BARU] Index untuk performa query pencairan
}

model ExpenseAttachment {
  id        String         @id @default(cuid())
  expenseId String
  expense   Expense        @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  
  type      AttachmentType
  fileUrl   String         @db.Text
  createdAt DateTime       @default(now())

  @@index([expenseId])
  @@index([type])
}

// [BARU] Model untuk mencatat riwayat Buku Kas / Saldo Operasional
model OperationalLedger {
  id            String          @id @default(cuid())
  type          TransactionType
  amount        Decimal         @db.Decimal(12, 2)
  balance       Decimal         @db.Decimal(12, 2) // Sisa saldo setelah transaksi ini
  description   String          @db.Text
  
  // Admin/Super Admin yang melakukan Top-Up atau Pencairan
  createdBy     String
  admin         User            @relation("AdminLedger", fields: [createdBy], references: [id])
  
  // Relasi jika transaksi ini adalah pencairan bon
  payoutBatchId String?         @unique
  payoutBatch   PayoutBatch?    @relation(fields: [payoutBatchId], references: [id])

  createdAt     DateTime        @default(now())

  @@index([type])
  @@index([createdAt])
}

// [BARU] Model untuk mengelompokkan bon yang dicairkan sekaligus
model PayoutBatch {
  id            String    @id @default(cuid())
  
  // Teknisi yang menerima pencairan
  technicianId  String
  technician    User      @relation("TechnicianPayouts", fields: [technicianId], references: [id])
  
  // Total nominal dari gabungan bon yang dicairkan
  totalAmount   Decimal   @db.Decimal(12, 2)
  
  // Relasi balik ke riwayat buku kas
  ledger        OperationalLedger?
  
  // Bon-bon apa saja yang dicairkan di batch ini
  expenses      Expense[] 
  
  // Admin yang melakukan pencairan
  paidById      String
  admin         User      @relation("AdminPayoutBatch", fields: [paidById], references: [id])
  
  createdAt     DateTime  @default(now())

  @@index([technicianId])
  @@index([createdAt])
}